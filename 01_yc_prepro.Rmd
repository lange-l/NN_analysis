---
title: "yc_behav_prepro"
author: "Lena Lange"
date: "2023-02-27"
output: html_document
---

Prepare data (concatenate all .txt files of exp_save) in Linux CLI:

cd /data/pt_02438/numbtouch_neglect/young_controls/yc_behav/
cat yc*/neglect3_*_trials_*.txt > yc_trials_tmp.txt
sed '2,${/ID*/d}' yc_trials_tmp.txt > yc_trials.txt

#### Packages, settings, load data frame

```{r setup, include=FALSE}

.libPaths("/data/pt_02438/lena/R/") # set path to save packages

library(tidyverse) # load packages
library(ggpubr)

options(scipen = 999) # turn off e notation

data_dir <- '/data/pt_02438/numbtouch_neglect/young_controls/yc_behav/'
plot_dir <- '/data/pt_02438/numbtouch_neglect//young_controls/yc_behav/plots/'

behav_data <- paste(data_dir, 'yc_trials.txt', sep = '')
df <- read.table(behav_data, header = TRUE, sep = "\t", fill = TRUE, stringsAsFactors = FALSE) # tab separated
```

#### Edit data frame
(drop unused columns, drop training block, rename experimental blocks, rename participants, delete re-recorded blocks)

```{r}

# drop irrelevant columns
df <- subset(df, select=-c(onset_fix, onset_cue01, onset_resp1, stim_onset, ao_error, onset_resp1_p, onset_resp2, t_trigger_ao))

# add stim column
df <- df %>%
  mutate(
    stim = 'NA',
    stim = ifelse(intensityF1>0, 1, stim),
    stim = ifelse(intensityF2>0, 2, stim),
    stim = ifelse((intensityF1==0 & intensityF2==0), 0, stim)
  )

# add detection column
df <- df %>%
  mutate(
    det = 'Na',
    det = ifelse(stim==1 & resp1 == 1, "hitF1", det),
    det = ifelse(stim==2 & resp1 == 1, "hitF2", det),
    det = ifelse(stim==1 & resp1 == 0, "missF1", det),
    det = ifelse(stim==2 & resp1 == 0, "missF2", det),
    det = ifelse(stim==0 & resp1 == 0, "CR", det),
    det = ifelse(stim==0 & resp1 == 1, "FA", det)
  )

# add localisation column
df <- df %>%
  mutate(
    loca = 'Na',
    loca = ifelse((stim==1 & resp2==1), "hit",loca),
    loca = ifelse((stim==1 & resp2==2), "miss", loca),
    loca = ifelse(stim==2 & resp2==2, "CR", loca),
    loca = ifelse(stim==2 & resp2==1, "FA", loca),
    loca = ifelse(stim==0, "catch",loca)
  )

# drop training block, rename experimental blocks
df <- subset(df,block!=1)

df$block <-replace(df$block, df$block==2, 1)
df$block <-replace(df$block, df$block==3, 2)
df$block <-replace(df$block, df$block==4, 3)
df$block <-replace(df$block, df$block==5, 4)
df$block <-replace(df$block, df$block==6, 5)

# rename first participant
df$ID <- replace(df$ID, ((df$ID==21) & (df$gender=="M")), 1)

# check ID & block values
unique(df$block)
unique(df$ID)

# add index column
df <- cbind(index = rownames(df), df)
rownames(df) <- 1:nrow(df)

# check which participants have more than 5 blocks recorded
df_i <- subset(df, df$ID==21)
unique(df_i$block)

# remove blocks that were re-recorded
# ID39, block 5
df <- df[-c(28369:28512), ]
# ID38, block 5
df <- df[-c(27505:27648), ]
# ID35, block 4
df <- df[-c(25201:25344), ]
# ID34, block 1
df <- df[-c(23905:24048), ]
# ID27, block 5 
df <- df[-c(19297:19440), ]
# ID21, block 3
df <- df[-c(14545:14688), ]

```


#### Filter 
-set min. & max. response times 
-set response buttons 
-create filter columns for response time and button press with 1s and 0s
-save df containing all trials for EEG data
-subset to only valid trials, save as .csv

```{r}
# Filter settings (0.15 s < response time < 5s)
resp1_min <- 0.15
resp1_max <- 5
resp2_min <- resp1_min
resp2_max <- resp1_max

resp1_btn <- c(3,4) # 3 = left button, 4 = right button
resp2_btn <- c(3,4)

# Create filter columns: trials that violate filter settings get 0, valid trials 1
df$resp_t_filter <- as.integer(df$resp1_t > resp1_min &
                                 df$resp1_t < resp1_max &
                                 df$resp2_t > resp2_min &
                                 df$resp2_t < resp2_max)

df$resp_btn_filter <- as.integer(match(df$resp1_btn, resp1_btn, 0) &
                                 match(df$resp2_btn, resp2_btn, 0))

df$resp_filter <- as.integer(df$resp_t_filter & df$resp_btn_filter)

print("number of trials rejected by response time filter:")
sum(df$resp_t_filter==0)
print("number of trials rejected by button press filter:")
sum(df$resp_btn_filter==0)
print("number of valid trials:")
sum(df$resp_filter==1)

# Save data frame with all trials included (to add metadata to EEG epochs)
df_python <- subset(df, select=c(index, ID, age, gender, block, miniblock, trial, block_type, stim, resp1, resp2, det, loca, resp_filter))

write.csv(df_python,"/data/pt_02438/numbtouch_neglect/young_controls/yc_behav/yc_trials.csv", row.names = FALSE)

# Apply filter
df_valid <- subset(df, resp_filter==1, select=c(ID, age, gender, block, miniblock, trial, block_type, stim, resp1, resp2, det, loca, resp1_t, resp2_t))

# Save pre-processed data frame
write.csv(df_valid,"/data/pt_02438/numbtouch_neglect/young_controls/yc_behav/yc_prepro.csv", row.names = FALSE)

```
