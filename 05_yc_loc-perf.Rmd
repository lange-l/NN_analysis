---
title: "calculate_loc-performance"
author: "Lena Lange"
date: "2023-07-18"
output: html_document
---

#### Package, settings, data frames

```{r setup, include=FALSE}
.libPaths("/data/pt_02438/lena/R/") # set path to save packages
library(tidyverse)

options(scipen = 999) # turn off e notation

data_dir <- '/data/pt_02438/numbtouch_neglect/young_controls/yc_behav/'
plot_dir <- '/data/pt_02438/numbtouch_neglect/young_controls/yc_behav/plots/'

behav_data <- paste(data_dir, 'yc_behav_excl.csv', sep = '')
df <- read.table(behav_data, header = TRUE, sep = ",", fill = TRUE, stringsAsFactors = FALSE) 

# drop irrelevant columns, exclude yc28 (after de-briefing questionnaire), exclude catch trials, add accuracy column (for localisation task)
df <- subset(df, ID!=28 & stim!=0, 
             select=c(ID, block, block_type, stim, resp1, resp2, det, loca, resp1_t, resp2_t)) %>%
  mutate(
    acc_loc = "Na",
    acc_loc = as.integer((stim==1 & resp2==1) | (stim==2 & resp2==2))
  )

# subset dfs for detected & undetected trials
df_det <- subset(df, det=="hitF1" | det=="hitF2") 
df_undet <- subset(df, det=="missF1" | det=="missF2")

```

#### Calculate localisation performance by detection x position

##### >> All trials

```{r}

df_perf_all <- df %>%
  mutate(
    loc_all = 'NaN',
    loc_anat = 'NaN',
    loc_cross = 'NaN',
  )

trials <- df %>%
  mutate(
    trials_all = NA_integer_,
    trials_anat = NA_integer_,
    trials_cross = NA_integer_,
  ) %>%
  group_by(ID, block, trials_all, trials_anat, trials_cross) %>%
  summarise()


# calculate loc_perf for every block individually:

for (i in unique(df$ID)) { # iterate over participants
  df_ID <- subset(df, ID==i)
  
  for (j in unique(df_ID$block)){ # iterate over blocks of current participant
    df_block <- subset(df_ID, block==j)
    
    df_a <- subset(df_block, block_type==1) # only anatomical
    df_c <- subset(df_block, block_type==2) # only crossed
    
    # calculate loc_performance including all trials (per position)
    df_perf_all <- df_perf_all %>% 
      mutate(
        loc_all = ifelse(((ID == i) & (block == j)), mean(df_block$acc_loc), loc_all),
        loc_anat = ifelse(((ID == i) & (block == j)), mean(df_a$acc_loc), loc_anat),
        loc_cross = ifelse(((ID == i) & (block == j)), mean(df_c$acc_loc), loc_cross)
      )
    
    # count trials per position
    trials <- trials %>% 
      mutate(
        trials_all = ifelse((ID == i) & (block == j), nrow(df_block), trials_all),
        trials_anat = ifelse((ID == i) & (block == j), nrow(df_a), trials_anat),
        trials_cross = ifelse((ID == i) & (block == j), nrow(df_c), trials_cross)
      )
  }
}


# summarise, pivot long, add detection columns, set performance column to numeric
df_perf_all_sum <- df_perf_all %>%
  group_by(ID, block, loc_all, loc_anat, loc_cross) %>%
  summarise() %>%
  select(ID, block, loc_all, loc_anat, loc_cross) %>%
  pivot_longer(cols = c(loc_all, loc_anat, loc_cross), 
               names_to="position", values_to="performance") %>%
  mutate(
  position = ifelse(position=="loc_all", "all", position),
  position = ifelse(position=="loc_anat", "anat", position),
  position = ifelse(position=="loc_cross", "cross", position),
  
  detection = 'all',
  
  performance = as.numeric(performance))


# pivot trials df into long format 
trials <- trials %>%
  pivot_longer(cols = c(trials_all, trials_anat, trials_cross),
               names_to = "position", values_to="n_trials") %>%
  mutate(
    position = ifelse(position=="trials_all", "all", position),
    position = ifelse(position=="trials_anat", "anat", position),
    position = ifelse(position=="trials_cross", "cross", position),
    
    n_trials = as.numeric(n_trials)) 


# add trial counts to loc_perf summary data frame
df_perf_all_sum <- cbind(df_perf_all_sum, n_trials = trials$n_trials) 

# average within-subjects loc_perf (by position), add detection column 
df_perf_all_av <- df_perf_all_sum %>%
  group_by(ID, position) %>%
  summarise(loc_perf = mean(performance),
            n_trials = sum(n_trials)) %>%
  mutate(detection = "all")

```

##### >> Undetected trials only

```{r}

df_perf_undet <- df %>%
  mutate(
    loc_all = 'NaN',
    loc_anat = 'NaN',
    loc_cross = 'NaN',
  )

trials_undet <- df %>%
  mutate(
    trials_all = NA_integer_,
    trials_anat = NA_integer_,
    trials_cross = NA_integer_,
  ) %>%
  group_by(ID, block, trials_all, trials_anat, trials_cross) %>%
  summarise()


# calculate loc_perf for every block individually:

for (i in unique(df_undet$ID)) { # iterate over participants
  df_ID <- subset(df_undet, ID==i)
  
  for (j in unique(df_ID$block)){ # iterate over blocks of current participant
    df_block <- subset(df_ID, block==j)
    
    df_a <- subset(df_block, block_type==1) # only anatomical
    df_c <- subset(df_block, block_type==2) # only crossed
    
    # calculate loc_performance including only undetected trials (per position)
    df_perf_undet <- df_perf_undet %>% 
      mutate(
        loc_all = ifelse(((ID == i) & (block == j)), mean(df_block$acc_loc), loc_all),
        loc_anat = ifelse(((ID == i) & (block == j)), mean(df_a$acc_loc), loc_anat),
        loc_cross = ifelse(((ID == i) & (block == j)), mean(df_c$acc_loc), loc_cross)
      )
    
    # count undetected trials per position
    trials_undet <- trials_undet %>% 
      mutate(
        trials_all = ifelse((ID == i) & (block == j), nrow(df_block), trials_all),
        trials_anat = ifelse((ID == i) & (block == j), nrow(df_a), trials_anat),
        trials_cross = ifelse((ID == i) & (block == j), nrow(df_c), trials_cross)
      )
  }
}


# summarise, pivot long, add detection columns, set performance column to numeric
df_perf_undet_sum <- df_perf_undet %>%
  group_by(ID, block, loc_all, loc_anat, loc_cross) %>%
  summarise() %>%
  select(ID, block, loc_all, loc_anat, loc_cross) %>%
  pivot_longer(cols = c(loc_all, loc_anat, loc_cross), 
               names_to="position", values_to="performance") %>%
  mutate(
  position = ifelse(position=="loc_all", "all", position),
  position = ifelse(position=="loc_anat", "anat", position),
  position = ifelse(position=="loc_cross", "cross", position),
  
  detection = 'undet',
  
  performance = as.numeric(performance))


# pivot undetected trials df into long format 
trials_undet <- trials_undet %>%
  pivot_longer(cols = c(trials_all, trials_anat, trials_cross),
               names_to = "position", values_to="n_trials") %>%
  mutate(
    position = ifelse(position=="trials_all", "all", position),
    position = ifelse(position=="trials_anat", "anat", position),
    position = ifelse(position=="trials_cross", "cross", position),
    
    n_trials = as.numeric(n_trials)) 


# add trial counts to loc_perf summary data frame
df_perf_undet_sum <- cbind(df_perf_undet_sum, n_trials = trials_undet$n_trials) 

# average within-subjects loc_perf (by position), add detection column 
df_perf_undet_av <- df_perf_undet_sum %>%
  group_by(ID, position) %>%
  summarise(loc_perf = mean(performance),
            n_trials = sum(n_trials)) %>%
  mutate(detection = "undet")

```

##### >> Detected trials only

```{r}
df_perf_det <- df %>%
  mutate(
    loc_all = 'NaN',
    loc_anat = 'NaN',
    loc_cross = 'NaN',
  )

trials_det <- df %>%
  mutate(
    trials_all = NA_integer_,
    trials_anat = NA_integer_,
    trials_cross = NA_integer_,
  ) %>%
  group_by(ID, block, trials_all, trials_anat, trials_cross) %>%
  summarise()


# calculate loc_perf for every block individually:

for (i in unique(df_det$ID)) { # iterate over participants
  df_ID <- subset(df_det, ID==i)
  
  for (j in unique(df_ID$block)){ # iterate over blocks of current participant
    df_block <- subset(df_ID, block==j)
    
    df_a <- subset(df_block, block_type==1) # only anatomical
    df_c <- subset(df_block, block_type==2) # only crossed
    
    # calculate loc_performance including only undetected trials (per position)
    df_perf_det <- df_perf_det %>% 
      mutate(
        loc_all = ifelse(((ID == i) & (block == j)), mean(df_block$acc_loc), loc_all),
        loc_anat = ifelse(((ID == i) & (block == j)), mean(df_a$acc_loc), loc_anat),
        loc_cross = ifelse(((ID == i) & (block == j)), mean(df_c$acc_loc), loc_cross)
      )
    
    # count detected trials per position
    trials_det <- trials_det %>% 
      mutate(
        trials_all = ifelse((ID == i) & (block == j), nrow(df_block), trials_all),
        trials_anat = ifelse((ID == i) & (block == j), nrow(df_a), trials_anat),
        trials_cross = ifelse((ID == i) & (block == j), nrow(df_c), trials_cross)
      )
  }
}


# summarise, pivot long, add detection columns, set performance column to numeric
df_perf_det_sum <- df_perf_det %>%
  group_by(ID, block, loc_all, loc_anat, loc_cross) %>%
  summarise() %>%
  select(ID, block, loc_all, loc_anat, loc_cross) %>%
  pivot_longer(cols = c(loc_all, loc_anat, loc_cross), 
               names_to="position", values_to="performance") %>%
  mutate(
  position = ifelse(position=="loc_all", "all", position),
  position = ifelse(position=="loc_anat", "anat", position),
  position = ifelse(position=="loc_cross", "cross", position),
  
  detection = 'det',
  
  performance = as.numeric(performance))


# pivot detected trials df into long format 
trials_det <- trials_det %>%
  pivot_longer(cols = c(trials_all, trials_anat, trials_cross),
               names_to = "position", values_to="n_trials") %>%
  mutate(
    position = ifelse(position=="trials_all", "all", position),
    position = ifelse(position=="trials_anat", "anat", position),
    position = ifelse(position=="trials_cross", "cross", position),
    
    n_trials = as.numeric(n_trials)) 


# add trial counts to loc_perf summary data frame
df_perf_det_sum <- cbind(df_perf_det_sum, n_trials = trials_det$n_trials) 

# average within-subjects loc_perf (by position), add detection column 
df_perf_det_av <- df_perf_det_sum %>%
  group_by(ID, position) %>%
  summarise(loc_perf = mean(performance),
            n_trials = sum(n_trials)) %>%
  mutate(detection = "det")

```

#### Bind together summary data frames for all, detected & undetected trials, save

```{r}
df_sum <- rbind(c=df_perf_all_sum, df_perf_det_sum, df_perf_undet_sum)
fname <- file.path(data_dir, "yc_locperf_sum.csv")
write.csv(df_sum, fname, row.names = FALSE)

df_av <- rbind(c=df_perf_all_av, df_perf_det_av, df_perf_undet_av)
fname <- file.path(data_dir, "yc_locperf_av.csv")
write.csv(df_av, fname, row.names = FALSE)

```

##### >> Undetected quick trials only (0.2 < resp1_t < 0.5 s) 

```{r}
df_quick <- df_undet %>%
  filter(resp1_t >= 0.2, resp1_t <= 0.5) %>%
  mutate(
    loc_all = 'NaN',
    loc_anat = 'NaN',
    loc_cross = 'NaN',
    
    trials_all = NA_integer_,
    trials_anat = NA_integer_,
    trials_cross = NA_integer_
  )


# calculate loc_perf for every block individually:

for (i in unique(df_quick$ID)) { # iterate over participants
  df_ID <- subset(df_quick, ID==i)
  
  for (j in unique(df_ID$block)){ # iterate over blocks of current participant
    df_block <- subset(df_ID, block==j)
    
    df_a <- subset(df_block, block_type==1) # only anatomical
    df_c <- subset(df_block, block_type==2) # only crossed
    
    # calculate loc_performance including only undetected trials, count trials (per position)
    df_quick <- df_quick %>% 
      mutate(
        loc_all = ifelse(((ID == i) & (block == j)), mean(df_block$acc_loc), loc_all),
        loc_anat = ifelse(((ID == i) & (block == j)), mean(df_a$acc_loc), loc_anat),
        loc_cross = ifelse(((ID == i) & (block == j)), mean(df_c$acc_loc), loc_cross),
        
        trials_all = ifelse((ID == i) & (block == j), nrow(df_block), trials_all),
        trials_anat = ifelse((ID == i) & (block == j), nrow(df_a), trials_anat),
        trials_cross = ifelse((ID == i) & (block == j), nrow(df_c), trials_cross)
      )
  }
}


# summarise, pivot long, add detection columns, set performance column to numeric
df_quick_sum <- df_quick %>%
  group_by(ID, block, loc_all, loc_anat, loc_cross) %>%
  summarise() %>%
  select(ID, block, loc_all, loc_anat, loc_cross) %>%
  pivot_longer(cols = c(loc_all, loc_anat, loc_cross), 
               names_to="position", values_to="performance") %>%
  mutate(
  position = ifelse(position=="loc_all", "all", position),
  position = ifelse(position=="loc_anat", "anat", position),
  position = ifelse(position=="loc_cross", "cross", position),
  
  detection = 'undet',
  
  performance = as.numeric(performance))


# pivot undetected trials df into long format 
trials_quick <- df_quick %>%
  group_by(ID, block, trials_all, trials_anat, trials_cross) %>%
  summarise() %>%
  pivot_longer(cols = c(trials_all, trials_anat, trials_cross),
               names_to = "position", values_to="n_trials") %>%
  mutate(
    position = ifelse(position=="trials_all", "all", position),
    position = ifelse(position=="trials_anat", "anat", position),
    position = ifelse(position=="trials_cross", "cross", position),
    
    n_trials = as.numeric(n_trials)) 


# add trial counts to loc_perf summary data frame
df_quick_sum <- cbind(df_quick_sum, n_trials = trials_quick$n_trials) 

# average within-subjects loc_perf (by position), add detection column 
df_quick_av <- df_quick_sum %>%
  group_by(ID, position) %>%
  summarise(loc_perf = mean(performance),
            n_trials = sum(n_trials)) %>%
  mutate(detection = "undet")

# save data frames
fname <- file.path(data_dir, "yc_loc-quick_sum.csv")
write.csv(df_quick_sum, fname, row.names = FALSE)

fname <- file.path(data_dir, "yc_loc-quick_av.csv")
write.csv(df_quick_av, fname, row.names = FALSE)

```

