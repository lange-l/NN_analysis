---
title: "calculate_det-performance"
author: "Lena Lange"
date: "2023-04-04"
output: html_document
---

Calculate detection performance per block:
detection performance = (hits + correct rejections) / number of trials in 1 block

Calculate within-subject mean detection performance:
mean detection performance = (det_perf1 + det_perf2 + ... + det_perfn) / (number of blocks)


#### Packages, settings & data frame

```{r setup, include=FALSE}
.libPaths("/data/pt_02438/lena/R/") # set path to save packages
library(tidyverse)

options(scipen = 999) # turn off e notation

# set paths & load data
data_dir <- '/data/pt_02438/numbtouch_neglect/young_controls/yc_behav/'
plot_dir <- '/data/pt_02438/numbtouch_neglect/young_controls/yc_behav/plots/'
behav_data <- paste(data_dir, 'yc_behav_excl.csv', sep = '')
df <- read.table(behav_data, header = TRUE, sep = ",", fill = TRUE, stringsAsFactors = FALSE) 

# edit data frame, add accuracy columns (1 for trials where answer to y/n task was correct, when incorrect 0)
df <- subset(df, select=c(ID, block, trial, block_type, stim, resp1, resp2, det)) %>%
  mutate(
    acc_det = 'Na',
    acc_det = as.integer((stim!=0 & resp1==1) | (stim==0 & resp1==0)) 
    )

```


## Calculate detection performance by finger x hand position

##### F1+F2 

```{r}

df_both <- df %>%
  mutate(
    det_all = 'NaN',
    det_anat = 'NaN',
    det_cross = 'NaN',
    
    trials_all = 'NaN',
    trials_anat = 'NaN',
    trials_cross = 'NaN'
  )

# calculate detection performance for every block individually: 

for (i in unique(df_both$ID)) { # iterate over participants
  df_ID <- subset(df_both, ID==i)
  
  for (j in unique(df_ID$block)){ # iterate over blocks of current participant
    df_block <- subset(df_ID, block==j)
    
    df_a <- subset(df_block, df_block$block_type==1) # subset df with only anatomical trials
    df_c <- subset(df_block, df_block$block_type==2) # subset df with only crossed trials
    
    df_both <- df_both %>%
      mutate( # for current block: calculate detection performance, count trials
        det_all = ifelse(((ID == i) & (block == j)), mean(df_block$acc_det), det_all),
        det_anat = ifelse(((ID == i) & (block == j)), mean(df_a$acc_det), det_anat),
        det_cross = ifelse(((ID == i) & (block == j)), mean(df_c$acc_det), det_cross),
        
        trials_all = ifelse(((ID == i) & (block == j)), nrow(df_block), trials_all),
        trials_anat = ifelse(((ID == i) & (block == j)), nrow(df_a), trials_anat),
        trials_cross = ifelse(((ID == i) & (block == j)), nrow(df_c), trials_cross)
        )
  }
}

rm(df_ID, df_block, df_a, df_c)


# summarise, pivot into long format
df_both_sum <- df_both %>%
  group_by(ID, block, det_all, det_anat, det_cross) %>%
  summarise() %>%
  pivot_longer(cols = c(det_all, det_anat, det_cross),
               names_to = "position", values_to="performance") %>%
  mutate(
    finger = 'both',
    position = ifelse((position=="det_all"), "all", position),
    position = ifelse((position=="det_anat"), "anat", position),
    position = ifelse((position=="det_cross"), "cross", position)
    ) %>%
  subset(select=c(ID, block, finger, position, performance)) 
  

# count trials per block and per position, add to summary data frame:
trials_both <- df_both %>%
  group_by(ID, block, trials_all, trials_anat, trials_cross) %>%
  summarise() %>%
  pivot_longer(cols = c(trials_all, trials_anat, trials_cross),
               names_to = "position", values_to="trials") %>%
  mutate(
    finger = 'both',
    position = ifelse((position=="trials_all"), "all", position),
    position = ifelse((position=="trials_anat"), "anat", position),
    position = ifelse((position=="trials_cross"), "cross", position)
    ) %>%
  subset(select=c(ID, block, finger, position, trials)) %>%
  mutate( trials = as.numeric(trials))

df_both_sum <- cbind(df_both_sum, trials = trials_both$trials)


# set performance & trial column to numeric:
df_both_sum <- df_both_sum %>%
  mutate(
    performance = as.numeric(performance),
    trials = as.numeric(trials)
  )


# calculate average detection performance within subjects (by position):
df_both_av <- df_both_sum %>%
  group_by(ID, position, finger) %>%
  summarise(performance = mean(performance)) 

# summarise trials per participant & add to average data frame:
trials_both_sum <- trials_both %>%
  group_by(ID, finger, position) %>%
  summarise(trials_all = sum(trials))

df_both_av <- cbind(df_both_av, trials = trials_both_sum$trials_all)

```

##### F1 

```{r}

df_F1 <- subset(df, df$stim!=2) %>%
  mutate(
    det_all = 'NaN',
    det_anat = 'NaN',
    det_cross = 'NaN',
    trials_all = 'NaN',
    trials_anat = 'NaN',
    trials_cross = 'NaN'
  )

# calculate detection performance for every block individually :

for (i in unique(df_F1$ID)) { # iterate over participants
  df_ID <- subset(df_F1, ID==i)
  
  for (j in unique(df_ID$block)){ # iterate over blocks of current participant
    df_block <- subset(df_ID, block==j)
    
    df_a <- subset(df_block, df_block$block_type==1) # subset data frames for positions
    df_c <- subset(df_block, df_block$block_type==2)
    
    df_F1 <- df_F1 %>%
      mutate( # calculate detection performance & count trials of current block:
        det_all = ifelse(((ID == i) & (block == j)), mean(df_block$acc_det), det_all),
        det_anat = ifelse(((ID == i) & (block == j)), mean(df_a$acc_det), det_anat),
        det_cross = ifelse(((ID == i) & (block == j)), mean(df_c$acc_det), det_cross),
        trials_all = ifelse(((ID == i) & (block == j)), nrow(df_block), trials_all),
        trials_anat = ifelse(((ID == i) & (block == j)), nrow(df_a), trials_anat),
        trials_cross = ifelse(((ID == i) & (block == j)), nrow(df_c), trials_cross)
        )
  }
}

rm(df_ID, df_block, df_a, df_c)


# summarise detection rates and pivot to long format:
df_F1_sum <- df_F1 %>%
  group_by(ID, block, det_all, det_anat, det_cross) %>%
  summarise() %>%
  pivot_longer(cols = c(det_all, det_anat, det_cross),
               names_to = "position", values_to="performance") %>%
  mutate(
    finger = 'F1',
    position = ifelse((position=="det_all"), "all", position),
    position = ifelse((position=="det_anat"), "anat", position),
    position = ifelse((position=="det_cross"), "cross", position)
    ) %>%
  subset(select=c(ID, block, performance, finger, position)) 
  

# summarise trials per block, pivot to long format and add to summary data frame:
trials_F1 <- df_F1 %>%
  group_by(ID, block, trials_all, trials_anat, trials_cross) %>%
  summarise() %>%
  pivot_longer(cols = c(trials_all, trials_anat, trials_cross),
               names_to = "position", values_to="trials") %>%
  mutate(
    finger = 'F1',
    position = ifelse((position=="trials_all"), "all", position),
    position = ifelse((position=="trials_anat"), "anat", position),
    position = ifelse((position=="trials_cross"), "cross", position)
    )%>%
  mutate( trials = as.numeric(trials)) 

df_F1_sum <- cbind(df_F1_sum, trials = trials_F1$trials)

# set performance column to numeric:
df_F1_sum <- df_F1_sum %>%
  mutate(
    performance = as.numeric(performance),
    trials = as.numeric(trials)
  )


# calculate average detection performance within subjects (by position):
df_F1_av <- df_F1_sum %>%
  group_by(ID, position, finger) %>%
  summarise(performance = mean(performance)) 

# summarise trials per participant & add to average data frame:
trials_F1_sum <- trials_F1 %>%
  group_by(ID, finger, position) %>%
  summarise(trials_all = sum(trials))

df_F1_av <- cbind(df_F1_av, trials = trials_F1_sum$trials_all)
```

##### F2 

```{r}
df_F2 <- subset(df, df$stim!=1) %>%
  mutate(
    det_all = 'NaN',
    det_anat = 'NaN',
    det_cross = 'NaN',
    trials_all = 'NaN',
    trials_anat = 'NaN',
    trials_cross = 'NaN'
  )

# calculate detection performance for every block individually: 

for (i in unique(df_F2$ID)) { # iterate over participants
  df_ID <- subset(df_F2, ID==i)
  
  for (j in unique(df_ID$block)){ # iterate over blocks of current participant
    df_block <- subset(df_ID, block==j)
    
    df_a <- subset(df_block, df_block$block_type==1) # subset data frames for positions
    df_c <- subset(df_block, df_block$block_type==2)
    
    df_F2 <- df_F2 %>%
      mutate( # calculate detection performance & count trials of current block:
        det_all = ifelse(((ID == i) & (block == j)), mean(df_block$acc_det), det_all),
        det_anat = ifelse(((ID == i) & (block == j)), mean(df_a$acc_det), det_anat),
        det_cross = ifelse(((ID == i) & (block == j)), mean(df_c$acc_det), det_cross),
        trials_all = ifelse(((ID == i) & (block == j)), nrow(df_block), trials_all),
        trials_anat = ifelse(((ID == i) & (block == j)), nrow(df_a), trials_anat),
        trials_cross = ifelse(((ID == i) & (block == j)), nrow(df_c), trials_cross)
        )
  }
}

rm(df_ID, df_block, df_a, df_c)


# summarise:
df_F2_sum <- df_F2 %>%  
  group_by(ID, block, det_all, det_anat, det_cross) %>%
  summarise() %>%
  pivot_longer(cols = c(det_all, det_anat, det_cross), 
               names_to = "position", values_to="performance") %>%
  mutate(
    finger = 'F2',
    position = ifelse((position=="det_all"), "all", position),
    position = ifelse((position=="det_anat"), "anat", position),
    position = ifelse((position=="det_cross"), "cross", position)
    ) %>%
  subset(select=c(ID, block, performance, finger, position))


# count trials per block and add to summary data frame:
trials_F2 <- df_F2 %>%
    group_by(ID, block, trials_all, trials_anat, trials_cross) %>%
  summarise() %>%
  pivot_longer(cols = c(trials_all, trials_anat, trials_cross),
               names_to = "position", values_to="trials") %>%
  mutate(
    finger = 'F1',
    position = ifelse((position=="trials_all"), "all", position),
    position = ifelse((position=="trials_anat"), "anat", position),
    position = ifelse((position=="trials_cross"), "cross", position)
    )%>%
  mutate( trials = as.numeric(trials)) 

df_F2_sum <- cbind(df_F2_sum, trials = trials_F2$trials)


# set performance & trials columns to numeric:
df_F2_sum <- df_F2_sum %>%
  mutate(
    performance = as.numeric(performance),
    trials = as.numeric(trials)
  )


# calculate average detection performance within subjects (by position):
df_F2_av <- df_F2_sum %>%
  group_by(ID, position, finger) %>%
  summarise(performance = mean(performance)) 


# count overall trials per participant & cbind to df_both_av:
trials_F2_sum <- trials_F2 %>%
  group_by(ID, finger, position) %>%
  summarise(trials_all = sum(trials))

df_F2_av <- cbind(df_F2_av, trials = trials_F2_sum$trials_all)
```

#### Bind together summary data frames for F1, F2 and F1+F2 and save them

```{r}

df_av <- rbind(c=df_both_av, df_F1_av, df_F2_av)
fname <- file.path(data_dir, "yc_detperf_av.csv")
write.csv(df_av, fname, row.names = FALSE)

df_sum <- rbind(c=df_both_sum, df_F1_sum, df_F2_sum)
fname <- file.path(data_dir, "yc_detperf_sum.csv")
write.csv(df_sum, fname, row.names = FALSE)

```


<!-- #### 1.4) Calculating weights  -->

<!-- ```{r} -->

<!-- df_sum <- rbind(c=df_both_sum, df_F1_sum, df_F2_sum) -->
<!-- df_av <- rbind(c=df_both_av, df_F1_av, df_F2_av) -->

<!-- # weights = n_trials_per_participant * (n_participants/n_trials_all_participants) -->
<!-- df_av <- df_av %>% -->
<!--   group_by(position, finger) %>% -->
<!--   mutate( -->
<!--     weights = trials * (length(unique(df_av$ID))/sum(trials)), -->
<!--     weights = as.numeric(weights), -->
<!--     position = as.factor(position), -->
<!--     finger = as.factor(finger) -->
<!--   ) -->

<!-- df_sum <- df_sum %>% -->
<!--   group_by(block, position, finger) %>% -->
<!--   mutate( -->
<!--     weights = trials * (length(unique(df_sum$ID))/sum(trials)), -->
<!--     weights = as.numeric(weights), -->
<!--     position = as.factor(position), -->
<!--     finger = as.factor(finger) -->
<!--   ) -->

<!-- fname <- file.path(data_dir, "yc_detperf_av.csv") -->
<!-- write.csv(df_av, fname, row.names = FALSE) -->

<!-- fname <- file.path(data_dir, "yc_detperf_sum.csv") -->
<!-- write.csv(df_sum, fname, row.names = FALSE) -->
<!-- ``` -->





